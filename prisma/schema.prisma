// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String               @id @default(cuid())
  name              String
  email             String               @unique
  hashedPassword    String
  avatarUrl         String?
  role              Role                 @default(USER)
  themePreference   ThemePreference?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  organizations     OrganizationMember[]
  projectsLed       Project[]            @relation("ProjectLead")
  reportedIssues    Issue[]              @relation("Reporter")
  assignedIssues    Issue[]              @relation("Assignee")
  comments          Comment[]
  attachments       Attachment[]
  activityLogs      ActivityLog[]
}

model Organization {
  id        String               @id @default(cuid())
  name      String
  slug      String               @unique
  ownerId   String
  plan      Plan                 @default(FREE)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  members   OrganizationMember[]
  projects  Project[]
}

model OrganizationMember {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  orgRole        OrgRole  @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model Project {
  id              String                @id @default(cuid())
  key             String
  name            String
  description     String?
  organizationId  String
  leadId          String?
  type            ProjectType
  defaultIssueType IssueType?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lead            User?                 @relation("ProjectLead", fields: [leadId], references: [id], onDelete: SetNull)
  boards          Board[]
  statuses        Status[]
  sprints         Sprint[]
  issues          Issue[]
  customFields    CustomField[]

  @@unique([organizationId, key])
}

model Board {
  id        String   @id @default(cuid())
  projectId String
  name      String
  type      ProjectType
  order     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues    Issue[]
}

model Status {
  id        String        @id @default(cuid())
  name      String
  category  StatusCategory
  projectId String
  order     Float
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues    Issue[]
}

model Sprint {
  id        String         @id @default(cuid())
  projectId String
  name      String
  goal      String?
  startDate DateTime?
  endDate   DateTime?
  status    SprintStatus   @default(FUTURE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues    IssueSprint[]
}

model Issue {
  id                    String                  @id @default(cuid())
  projectId             String
  boardId               String?
  statusId              String
  key                   String
  title                 String
  description           String?
  type                  IssueType
  priority              Priority
  reporterId            String
  assigneeId            String?
  estimatePoints        Float?
  dueDate               DateTime?
  parentIssueId         String?
  order                 Float                   @default(0)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  project               Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  board                 Board?                  @relation(fields: [boardId], references: [id])
  status                Status                  @relation(fields: [statusId], references: [id], onDelete: Restrict)
  reporter              User                    @relation("Reporter", fields: [reporterId], references: [id], onDelete: Restrict)
  assignee              User?                   @relation("Assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  parentIssue           Issue?                  @relation("Subtasks", fields: [parentIssueId], references: [id], onDelete: SetNull)
  subtasks              Issue[]                 @relation("Subtasks")
  sprints               IssueSprint[]
  comments              Comment[]
  attachments           Attachment[]
  activityLogs          ActivityLog[]
  customFieldValues     IssueCustomFieldValue[]

  @@unique([projectId, key])
  @@index([assigneeId])
  @@index([statusId])
}

model IssueSprint {
  id        String   @id @default(cuid())
  issueId   String
  sprintId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  sprint    Sprint   @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@unique([issueId, sprintId])
}

model Comment {
  id        String   @id @default(cuid())
  issueId   String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Attachment {
  id         String   @id @default(cuid())
  issueId    String
  uploaderId String
  fileName   String
  fileUrl    String
  fileSize   Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  issue      Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  uploader   User     @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
}

model ActivityLog {
  id        String     @id @default(cuid())
  issueId   String
  actorId   String
  type      String // e.g., STATUS_CHANGED, ASSIGNEE_CHANGED
  metadata  Json
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  issue     Issue      @relation(fields: [issueId], references: [id], onDelete: Cascade)
  actor     User       @relation(fields: [actorId], references: [id], onDelete: Cascade)
}

model CustomField {
  id        String                  @id @default(cuid())
  projectId String
  name      String
  key       String
  type      CustomFieldType
  config    Json // e.g., { options: ["A", "B"] } for SELECT
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  project   Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  values    IssueCustomFieldValue[]

  @@unique([projectId, key])
}

model IssueCustomFieldValue {
  id            String      @id @default(cuid())
  issueId       String
  customFieldId String
  value         String // Can be JSON string for complex values
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  issue         Issue       @relation(fields: [issueId], references: [id], onDelete: Cascade)
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([issueId, customFieldId])
}


// Enums

enum Role {
  USER
  ADMIN
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

enum Plan {
  FREE
  PRO
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum ProjectType {
  KANBAN
  SCRUM
}

enum StatusCategory {
  TODO
  IN_PROGRESS
  DONE
}

enum SprintStatus {
  FUTURE
  ACTIVE
  COMPLETED
}

enum IssueType {
  STORY
  TASK
  BUG
  EPIC
}

enum Priority {
  NONE
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  SELECT
  MULTISELECT
  DATE
}
